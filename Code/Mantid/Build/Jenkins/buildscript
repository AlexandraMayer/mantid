#!/bin/sh -ex
###############################################################################
# SCRIPT TO DRIVE THE JENKINS BUILDS OF MANTID.
#
# Notes:
#
# WORKSPACE & NODE_LABEL are environment variables that are set by Jenkins.
#   The latter corresponds to any labels set on a slave.
# BUILD_THREADS should be set in the configuration of each slave.
###############################################################################

###############################################################################
# OS X setup steps
###############################################################################
if [[ $(uname) == 'Darwin' ]]; then
  cd $WORKSPACE/Code
  ./fetch_Third_Party.sh
  # Setup environment variables
  source /opt/intel/bin/iccvars.sh intel64
  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$WORKSPACE/Code/Third_Party/lib/mac64:/Library/Frameworks
  # Make sure we pick up the Intel compiler
  export CC=icc
  export CXX=icpc
fi

###############################################################################
# RHEL6 setup steps - nodes must have a "rhel6" label set (in lowercase)
###############################################################################
if [[ ${NODE_LABELS} == *rhel6* ]]; then
  SCL_ON_RHEL6="scl enable mantidlibs"
else
  SCL_ON_RHEL6="eval"
fi

###############################################################################
# Create the build directory if it doesn't exist
###############################################################################
[ -d $WORKSPACE/build ] || mkdir $WORKSPACE/build
cd $WORKSPACE/build

###############################################################################
# CMake configuration
###############################################################################
$SCL_ON_RHEL6 "cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_CPACK=ON ../Code/Mantid"

###############################################################################
# Build step
###############################################################################
make -j$BUILD_THREADS KernelTest

###############################################################################
# Run the tests
###############################################################################
# Remove any Mantid.user.properties file
rm ~/.mantid/Mantid.user.properties
# Run Tests
ctest -j$BUILD_THREADS --output-on-failure --timeout 30 -E MantidPlot
# Run GUI tests serially
ctest --output-on-failure --timeout 30 -R MantidPlot

