#For Tests

import os
import platform
import sys

import MantidBuild

Import('env')

libList = env['MYLIBLIST']
libDirList = env['MYLIBDIRLIST']
cppPath = env['CPPPATH']
myenv = env.Clone()
myenv.Append(CPPDEFINES=[('IN_MANTID_TESTS',1)])
myenv.Append(CPPPATH=cppPath + ['../../../Third_Party/src/cxxtest'])

# Add the location of the gmock library
third_party_path = '../../../Third_Party/lib/'

if platform.dist()[2] == 'Tikanga':
    third_party_path += 'rhel5'
elif sys.platform == 'darwin':
    # Get the version as a tuple
    mac_version = tuple(platform.mac_ver()[0].split(".")[0:2])
    snow_leopard = ('10', '6')
    if mac_version >= snow_leopard:
        third_party_path += 'mac-10.6'
    else:
        third_party_path += 'mac'
elif os.name == 'nt':
    if platform.architecture()[0] == '64bit':
        third_party_path += 'win64'
    else:
        third_party_path += 'win32'
else:
    raise RuntimeError('Cannot find third party libraries. Unsupported build platform.')

myenv.Append(LIBPATH=libDirList+[third_party_path])
myenv.Append(LIBS=libList+['gmock'])

#GET LIST OF TESTS
path = '../../'
testfolder = '/test'

testsToRun = []

#get list of directories in trunk
dirList = os.listdir(path)

#Find Cxxtestgen
cxxtestgen = 'python ../../../Third_Party/src/cxxtest/cxxtestgen.py'

for fname in dirList:
  # Disable tests that are to do with multi-dimensional objects/algorithms until something useful is there
  if fname.startswith('MD'):
    continue
  if os.path.isdir(path + fname):
      #does folder contain /test?
      fullpath=path + fname + testfolder
      if os.path.exists(fullpath) and len(os.listdir(fullpath)) > 0:
        #generate the test cpp file
        os.popen(cxxtestgen + ' --runner=MantidPrinter -o ' + fname + '.cpp '+ path + fname + testfolder +'/*.h')
        #If there are not tests then there will be no cpp file created
        if os.path.exists(fname + ".cpp"):
          testsToRun.append(fname)

#BUILD the tests
if platform.system() == 'Darwin':
	myenv.Append(LIBS='python' + sys.version[0:3])
for test in testsToRun:
  temp= test.split('/')
  myenv.Append(CPPPATH='#/'+test+'/inc')
  myenv.Append(LIBS='Mantid'+test)
  dotcpp = test + '.cpp'
  dotpdb = test + '.pdb'
  myenv.Program([dotcpp], PDB=dotpdb)

