<?xml version="1.0" encoding="UTF-8"?>
<!-- For help on the notation used to specify an Instrument Definition File
see http://www.mantidproject.org/IDF -->
<instrument xmlns="http://www.mantidproject.org/IDF/1.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.mantidproject.org/IDF/1.0 Schema/IDFSchema.xsd"
            name="IMAT" valid-from ="2016-07-15 00:00:00"
            valid-to ="2100-01-01 23:59:59"
            last-modified="2016-08-03 18:46:01">
  <defaults>
    <length unit="meter"/>
    <angle unit="degree"/>
    <reference-frame>
      <!-- The z-axis is set parallel to and in the direction of the beam. the
           y-axis points up and the coordinate system is right handed. -->
      <along-beam axis="z"/>
      <pointing-up axis="y"/>
      <handedness val="right"/>
    </reference-frame>
    <default-view axis-view="z"/>
  </defaults>
  <!-- BRIEF DESCRIPTION OF IMAT INSTRUMENT:
       IMAT (Imaging and Materials Science & Engineering)
  -->
<!-- First, the source, sample and monitors -->

<component type="some source type">
  <location z="-56.0" />
</component>
<component type="sample position">
  <location />
</component>
<type name="some source type" is="Source">
  <properties />
</type>
<type name="sample position" is="SamplePos">
  <properties />
</type>

<!-- Monitor locations are approximate guesses for now! -->

<!-- Monitors -->
<component type="monitors" idlist="monitors">
  <location />
</component>


<type name="monitors">
  <component type="monitor-cylinder">
     <!--Example, first monitor is at 11.6534 m from the source, in the direction towards the sample => z = 11.6534 - 56 = -44.3466 (from the sample, which is at z=0)-->
    <!--11.6534 - 56 -->
    <location z="-44.3466" name="monitor1a"/>  
    <location z="-44.3466" name="monitor1b"/>
    <!--19.8144 - 56 -->
    <location z="-36.1856" name="monitor2a"/>  
    <location z="-36.1856" name="monitor2b"/>
    <!--20.8944 - 56 -->
    <location z="-35.1056" name="monitor3a"/>  
    <location z="-35.1056" name="monitor3b"/>
    <!--46.1774 - 56 -->
    <location z="-9.8226" name="monitor4a"/>  
    <location z="-9.8226" name="monitor4b"/>
    
    <!--49.0 - 56 -->
    <location z="-7" name="monitor5a"/>  
    <location z="-7" name="monitor5b"/>
  
  </component>

  <!-- We don't really care about those showing up in the Instrument View -->
  <component type="dummy-monitor">
    <!--56 - 56-->
    <location z="0.0" name="CalMon"/>   
  
    <!--60 - 56-->
    <location z="4.0" name="He_in"/>   
    <location z="4.0" name="He_out"/>
    <!--dummy monitor (off) -->
    <location z="0"/>  
  </component>
</type>

<!-- Shape of the monitors -->
<type name="dummy-monitor" is="monitor">
<!-- empty definition of dummy monitor -->
</type>
<type name="monitor-cylinder" is="monitor">
  <properties>
    Copied from monitor.dat:

    name:: box
    rank:: 2
    dimensions:: 2 4
    values:: -45.00  -2.00
    45.00  -2.00
    135.00  -2.00
    225.00  -2.00
  </properties>

  <cylinder id="cylinder-shape">
    <centre-of-bottom-base r="0.0" t="0.0" p="0.0" />
    <axis x="0.0" y="0.0" z="1.0" />
    <radius val="0.01" />
    <height val="0.03" />
  </cylinder>
</type>

<!-- IDs for the monitors -->
<idlist idname="monitors">
  <id start="0" end="13" />
</idlist>

<!-- There are two banks, North and South. 
     Each bank contains five modules, stacked vertically above each other. 
     The modules are of identical design, but the modules are not quite symmetrical in the horizontal direction.
     Accordingly, the modules in the South bank are installed upside down relative to those in the North bank.
     This ensures that the range of two-theta angles is the same for both banks. -->
<component name="NorthBank" type="detector-bank" idlist="NorthBank">
  <!-- The North bank is on the left, as viewed from the neutron source looking towards the sample.
       In the coordinate system of the bank, X axis points in direction of increasing two theta (to the
	   left as viewed from the sample position), Y axis points upwards, and the Z axis faces away from gauge volume. -->
  <location x="0" y="0" z="0" rot="90" axis-x="0" axis-y="1" axis-z="0"/>
</component>

<component name="SouthBank" type="detector-bank" idlist="SouthBank">
  <!-- The South bank is on the right, so rotate 90 degrees the other way this time -->
  <location x="0" y="0" z="0" rot="-90" axis-x="0" axis-y="1" axis-z="0">
    <!-- However, this would mean that the X axis is pointing towards the low end of the two theta range.
	     The detector pixels are not symmetrically distributed around the centre of the module, and this
		 would make the pixel distribution back to front. So, we rotate the entire bank around the (new)
		 Z-axis, turning it upside down. The pixel two theta values will be correct, but the order of the
		 modules is therefore top-to-bottom for the South bank, even though they are defined below from
		 bottom to top. The new Y axis will also point downwards. -->
    <rot val="180" axis-x="0" axis-y="0" axis-z="1" />
  </location>
</component>

<!-- 20150813: Detector modules have been swapped in the vertical axis (old module 5 is now 1,
     old module 4 is now 2, and vice-versa. It now looks correct. Verified with data from runs
     205819 and 205820. -->
<type name="detector-bank">
  <properties />
  <component type="detector-module">
    <location  x="0" y="0" z="0" rot="17" axis-x="1" axis-y="0" axis-z="0"/>
    <location  x="0" y="0" z="0" rot="8.5" axis-x="1" axis-y="0" axis-z="0"/>
    <location  x="0" y="0" z="0" rot="0" axis-x="1" axis-y="0" axis-z="0"/>
    <location  x="0" y="0" z="0" rot="-8.5" axis-x="1" axis-y="0" axis-z="0"/>
    <location  x="0" y="0" z="0" rot="-17" axis-x="1" axis-y="0" axis-z="0"/>
  </component>
</type>

<type name="detector-module">
  <!-- Z axis faces away from gauge volume, so that we can use 'facing'.
       Note that all components created so far (both the banks and the modules within
       the banks) are located at 0,0,0 (the sample position) but with different orientations. -->
  <!-- The modules are divided internally into 9 blocks of 25 pixels each, giving 225 pixels.
       The pixel at the lowest two-theta and the two pixels at the highest two-theta are not used,
	   giving 240 active pixels over the width of the module. The is a small gap of about 2.2 mm
	   between the blocks, although the design is specified in terms of a 3 mm pixel pitch within
	   the block, and 3.2 degree two-theta offset between the centre of neighbouring blocks.
	   The blocks, and the pixels within each block, are specified in order from the lowest to the
	   highest two-theta -->
  <component type="detector-block">
    <!-- We have a total of 9 detector blocks per ROW -->
    <!-- One of these -->
    <location  r="1.5" t="-12.8" p="0"><facing x="0.0" y="0.0" z="0.0"/> </location>
    <!-- Seven of these -->
    <location  r="1.5" t="-9.6" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="-6.4" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="-3.2" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="0.0" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="3.2" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="6.4" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <location  r="1.5" t="9.6" p="0"> <facing x="0.0" y="0.0" z="0.0"/> </location>
    <!-- One of these -->
    <location  r="1.5" t="9.6" p="0">
	    <facing x="0.0" y="0.0" z="0.0"/> </location>
		  <!--removed from inside location ^ <exclude sub-part="pixel24" />
		  <exclude sub-part="pixel25" />-->
  </component>
</type>
<!-- There might be some transmission detector ids left over ? try adding more down-->
<!-- Pixels inside a single detector block -->
<type name="detector-block">
  <!--# we only need 180 pixels per row-->
  <component type="detector-pixel">
    <location x="-0.048" y="0" z="0" name="pixel1" />
    <location x="-0.044" y="0" z="0" name="pixel2" />
    <location x="-0.040" y="0" z="0" name="pixel3" />
    <location x="-0.036" y="0" z="0" name="pixel4" />
    <location x="-0.032" y="0" z="0" name="pixel5" />
    <location x="-0.028" y="0" z="0" name="pixel6" />
    <location x="-0.024" y="0" z="0" name="pixel7" />
    <location x="-0.020" y="0" z="0" name="pixel8" />
    <location x="-0.016" y="0" z="0" name="pixel9" />
    <location x="-0.012" y="0" z="0" name="pixel10" />
    <location x="-0.008" y="0" z="0" name="pixel11" />
    <location x="-0.004" y="0" z="0" name="pixel12" />
    <location x="0.000" y="0" z="0" name="pixel13" />
    <location x="0.004" y="0" z="0" name="pixel14" />
    <location x="0.008" y="0" z="0" name="pixel15" />
    <location x="0.012" y="0" z="0" name="pixel16" />
    <location x="0.016" y="0" z="0" name="pixel17" />
    <location x="0.020" y="0" z="0" name="pixel18" />
    <location x="0.028" y="0" z="0" name="pixel20" /> 
    <location x="0.024" y="0" z="0" name="pixel19" />
    <!--<location x="0.032" y="0" z="0" name="pixel21" />
    <location x="0.036" y="0" z="0" name="pixel22" />
    <location x="0.040" y="0" z="0" name="pixel23" />
    <location x="0.044" y="0" z="0" name="pixel24" />
    <location x="0.048" y="0" z="0" name="pixel25" />-->
  </component>
</type>

<type name="detector-pixel" is="detector">
  <cuboid id="shape">
    <left-front-bottom-point x="-0.0015" y="-0.092" z="0.0"  />
    <left-front-top-point  x="-0.0015" y="0.092" z="0.0"  />
    <left-back-bottom-point  x="-0.0015" y="-0.092" z="0.001"  />
    <right-front-bottom-point  x="0.0015" y="-0.092" z="0.0"  />
  </cuboid>
  <algebra val="shape" />
</type>

<!-- 2 banks, 100 detectors per line, 900 total -->
<idlist idname="NorthBank">
  <!-- 100 detectors per line -->
  <id start="100001" end="100100"/>
  <id start="101001" end="101100"/>
  <!--<id start="102001" end="102100"/>
  <id start="103001" end="103100"/>
  <id start="104001" end="104100"/>
  <id start="105001" end="105100"/>
  <id start="106001" end="106100"/>
  <id start="107001" end="107100"/>
  <id start="108001" end="108100"/>-->
</idlist>

<idlist idname="SouthBank">
  <!--<id start="118001" end="118100"/>
  <id start="119001" end="119100"/>  
  <id start="116001" end="116100"/>
  <id start="117001" end="117100"/>
  <id start="114001" end="114100"/>
  <id start="115001" end="115100"/>
  <id start="112001" end="112100"/>
  <id start="113001" end="113100"/>
  <id start="110001" end="110100"/>-->
</idlist>

</instrument>
