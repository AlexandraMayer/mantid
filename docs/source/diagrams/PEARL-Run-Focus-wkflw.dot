digraph PearlDiffractionISIS {
    label="Focus Run PearlDiffractionISIS"
    //$global_style
    
    // Global prefix: Focus_run_
    
    Focus_run_start             [label="Start Focus Run"]
    Focus_run_start_FocusModeAll    [label="Focus Mode: 'all'"]
    Focus_run_start_FocusModeGroups [label="Focus Mode: 'groups'"]
    
    subgraph params {
    //$param_style
    
    Focus_run_param_current_run_number  [label="Current run number"]
    Focus_run_param_vanadium_norm       [label="Vanadium normalisation flag"]
    Focus_run_param_f_mode              [label="fmode"]
    
    Focus_run_param_focus_mode          [label="focus_mode"]
    
    // Global output directory
    Focus_run_param_userDataProcessed_FocusModeAll   [label="Global userDataProcessed (output directory)"]
    
    } // End of params
    
    subgraph processes {
    //$process_style

    // Read steps - suffix:read
    Focus_run_get_calib_files_read      [label="Get calibration files"]
    Focus_run_read                      [label="Pearl Read"]
    
    Focus_run_process_FocusModeAll      [label="Focus Mode: 'all'"]
    Focus_run_process_FocusModeGroups   [label="Focus Mode: 'groups'"]
    
    
    } //End of processes
    
    subgraph algorithms {
    //$algorithm_style
    
    // Read steps - suffix:read
    AlignDetectors_read                 [label="Align Detectors"]
    DiffractionFocusing_read            [label="Diffraction Focussing"]
    Rebin_read                          [label="Rebin"]
    Remove_temp_workspace_read          [label="Remove intermediate workspace"]
    
    
    //Vanadium calibration steps if true - Suffix:VanCalibTrue
    LoadNexus_VanCalibTrue              [label="Load Nexus file"]
    ExtractSingleSpectrum_VanCalibTrue  [label="Extract single spectrum"]
    Rebin_Step_One_VanCalibTrue         [label="Rebin"]
    ConvertUnits_TOF_VanCalibTrue       [label="Convert units to TOF"]
    Rebin_Step_Two_VanCalibTrue         [label="Rebin"]
    Divide_VanCalibTrue                 [label="Divide"]
    CropWorkspace_VanCalibTrue          [label="Crop workspace"]
    Scale_VanCalibTrue                  [label="Scale"]

    //Vanadium calibration steps if false - Suffix:VanCalibFalse
    ExtractSingleSpectrum_VanCalibFalse [label="Extract single spectrum"]
    ConvertUnits_TOF_VanCalibFalse      [label="Convert units to TOF"]
    Rebin_VanCalibFalse                 [label="Rebin"]
    CropWorkspace_VanCalibFalse         [label="Crop workspace"]
    
    //Vanadium calibration steps - Suffix: VanCalib
    Remove_temp_workspace_VanCalib      [label="Remove intermediate workspaces"]
    
    //Focus mode set to 'all' steps - Suffix: FocusModeAll
    CloneWorkspace_FocusModeAll         [label="Clone workspace"]
    Plus_FocusModeAll                   [label="Plus"]
    Scale_FocusModeAll                  [label="Scale"]
    SaveGSS_FocusModeAll                [label="Save GSS file"]
    ConvertUnits_dSpacing_FocusModeAll  [label="Convert units to dSpacing"]
    SaveNexus_FocusModeAll              [label="Save Nexus file"]
    Remove_temp_workspace_FocusModeAll  [label="Remove intermediate workspaces"]
    
    //Focus mode set to 'groups' steps - Suffix: FocusModeGroups
    CloneWorkspace_FocusModeGroups      [label="Clone Workspace"]
    Plus_StepOne_FocusModeGroups        [label="Plus"]
    Plus_StepTwo_FocusModeGroups        [label="Plus"]
    Plus_StepThree_FocusModeGroups      [label="Plus"]
    Plus_StepFour_FocusModeGroups       [label="Plus"]
    Scale_StepOne_FocusModeGroups       [label="Scale"]
    Scale_StepTwo_FocusModeGroups       [label="Scale"]
    SaveGSS_Mode1_FocusModeGroups       [label="Save GSS File"]
    SaveGSS_Mode2_FocusModeGroups       [label="Save GSS File"]
    ConvertUnits_FocusModeGroups        [label="Convert Units"]
    SaveNexus_FocusMode_Groups          [label="Save Nexus File"]
    SaveGSS_Range_FocusModeGroups       [label="Save GSS File"]
    ConvertUnits_PreSave_FocusModeGroups [label="Convert Units"]
    SaveNexus_Range_FocusModeGroups     [label="Save Nexus File"]
    Remove_temp_workspace_FocusModeGroups [label="Remove intermediate workspaces"]
    
    } //End of algorithms
    
    subgraph decisions {
    //$decision_style
    
    // Debug checks
    Focus_run_if_debug_mode_read        [label="If debug mode"]
    Focus_run_if_debug_mode_VanCalib    [label="If debug mode"]
    Focus_run_if_debug_mode_FocusModeAll    [label="If debug mode"]
    Focus_run_if_debug_mode_FocusModeGroups [label="If debug mode"]
    
    
    Focus_run_switch_f_mode             [label="fmode set to:"]
    Focus_run_if_van_norm               [label="If vanadium normalisation"]
    Focus_run_if_focus_mode             [label="focus_mode set to:"]
    
    } //End of decisions
    
    subgraph Focus_run_main_alg {
    
    // Read step - Suffix:read
    Focus_run_start                     -> Focus_run_get_calib_files_read
    Focus_run_get_calib_files_read      -> Focus_run_read
    Focus_run_param_current_run_number  -> Focus_run_read
    Focus_run_read                      -> Rebin_read
    Rebin_read                          -> AlignDetectors_read
    AlignDetectors_read                 -> DiffractionFocusing_read
    DiffractionFocusing_read            -> Focus_run_if_debug_mode_read
    
    // Debug mode is off:
    Focus_run_if_debug_mode_read        -> Remove_temp_workspace_read       [label="false"]
    Remove_temp_workspace_read          -> Focus_run_if_van_norm
    // Debug mode is on (ie. don't remove temp workspaces)
    Focus_run_if_debug_mode_read        -> Focus_run_if_van_norm            [label="true"]
    
    //Vanadium calibration steps if true - Suffix:VanCalibTrue
    Focus_run_param_vanadium_norm       -> Focus_run_if_van_norm
    // If we are using vanadium calibration
    Focus_run_if_van_norm               -> LoadNexus_VanCalibTrue           [label="true"]
    LoadNexus_VanCalibTrue              -> ExtractSingleSpectrum_VanCalibTrue
    ExtractSingleSpectrum_VanCalibTrue  -> Rebin_Step_One_VanCalibTrue
    Rebin_Step_One_VanCalibTrue         -> ConvertUnits_TOF_VanCalibTrue 
    ConvertUnits_TOF_VanCalibTrue       -> Rebin_Step_Two_VanCalibTrue
    Rebin_Step_Two_VanCalibTrue         -> Divide_VanCalibTrue
    Divide_VanCalibTrue                 -> CropWorkspace_VanCalibTrue
    CropWorkspace_VanCalibTrue          -> Scale_VanCalibTrue
    Scale_VanCalibTrue                  -> Focus_run_if_debug_mode_VanCalib

    //Vanadium calibration steps if false - Suffix:VanCalibFalse
    // If we are NOT using a vanadium calibration
    Focus_run_if_van_norm               -> ExtractSingleSpectrum_VanCalibFalse [label="false"]
    ExtractSingleSpectrum_VanCalibFalse -> ConvertUnits_TOF_VanCalibFalse
    ConvertUnits_TOF_VanCalibFalse      -> Rebin_VanCalibFalse
    Rebin_VanCalibFalse                 -> CropWorkspace_VanCalibFalse
    CropWorkspace_VanCalibFalse         -> Focus_run_if_debug_mode_VanCalib
    
    // Finished vanadium calibration - debug mode flag test
    // Debug mode is off:
    Focus_run_if_debug_mode_VanCalib    -> Remove_temp_workspace_VanCalib   [label="false"]
    Remove_temp_workspace_VanCalib      -> Focus_run_switch_f_mode
    // Debug mode is on (ie. don't remove temp workspaces)
    Focus_run_if_debug_mode_VanCalib    -> Focus_run_switch_f_mode          [label="true"]
    
    // Check the param to determine next behaviour 
    Focus_run_param_f_mode              -> Focus_run_switch_f_mode  
    Focus_run_switch_f_mode             -> Focus_run_process_FocusModeAll   [label="all"]
    Focus_run_switch_f_mode             -> Focus_run_process_FocusModeGroups [label="groups"]
    
    
    }
    
    
    
    subgraph Focus_run_FocusModeAll{
    //Focus mode set to 'all' steps - Suffix: FocusModeAll
    Focus_run_start_FocusModeAll        -> CloneWorkspace_FocusModeAll
    CloneWorkspace_FocusModeAll         -> Plus_FocusModeAll
    Plus_FocusModeAll                   -> Plus_FocusModeAll                [label="Input workspaces 1-9"]
    Plus_FocusModeAll                   -> Scale_FocusModeAll               [label="Sum of all inputs"]
    Scale_FocusModeAll                  -> SaveGSS_FocusModeAll
    Focus_run_param_userDataProcessed_FocusModeAll -> SaveGSS_FocusModeAll  
    SaveGSS_FocusModeAll                -> ConvertUnits_dSpacing_FocusModeAll   [label="Filename: 'PRL_<cycleNumber>.gss'"]
    ConvertUnits_dSpacing_FocusModeAll  -> SaveNexus_FocusModeAll
    Focus_run_param_userDataProcessed_FocusModeAll -> SaveNexus_FocusModeAll
    SaveNexus_FocusModeAll              -> Focus_run_if_debug_mode_FocusModeAll [label="Filename: 'PRL_<cycleNumber>.nxs'"]
    //Finally debug mode test
    // Debug mode is off:
    Focus_run_if_debug_mode_FocusModeAll -> Remove_temp_workspace_FocusModeAll  [label="false"] 
    
    }
    
    subgraph Focus_run_FocusModeGroups{
    //Focus mode set to 'groups' steps - Suffix: FocusModeGroups
    Focus_run_start_FocusModeGroups     -> CloneWorkspace_FocusModeGroups
    //First workspaces 0-2 - we will 1 based index as that's what Mantid will output 
    CloneWorkspace_FocusModeGroups      -> Plus_StepOne_FocusModeGroups     [label="Workspaces 1,2,3"]
    CloneWorkspace_FocusModeGroups      -> Plus_StepTwo_FocusModeGroups     [label="Workspaces 4,5,6"]
    CloneWorkspace_FocusModeGroups      -> Plus_StepThree_FocusModeGroups   [label="Workspaces 7,8,9"]
    Plus_StepOne_FocusModeGroups        -> Scale_StepOne_FocusModeGroups    [label="Sum all in groups"]
    Plus_StepTwo_FocusModeGroups        -> Scale_StepOne_FocusModeGroups    [label="Sum all in groups"]
    Plus_StepThree_FocusModeGroups      -> Scale_StepOne_FocusModeGroups    [label="Sum all in groups"]
    // Add left and right 90 degree bank modules
    Scale_StepOne_FocusModeGroups       -> Plus_StepFour_FocusModeGroups
    Plus_StepFour_FocusModeGroups       -> Scale_StepTwo_FocusModeGroups    [label="Add left and right banks (4-9)"]
    Scale_StepTwo_FocusModeGroups       -> Focus_run_if_focus_mode      
    // Focus_mode '1' saving:
    Focus_run_if_focus_mode             -> SaveGSS_Mode1_FocusModeGroups    [label="'1'"]
    SaveGSS_Mode1_FocusModeGroups       -> ConvertUnits_FocusModeGroups     [label="Appending to Filename: 'PRL_<cycleNumber>.gss'"]
    // Focus Mode '2' saving:
    Focus_run_if_focus_mode             -> SaveGSS_Mode2_FocusModeGroups    [label="'2'"]
    SaveGSS_Mode2_FocusModeGroups       -> ConvertUnits_FocusModeGroups     [label="Not appending to Filename: 'PRL_<cycleNumber>.gss'"]
    ConvertUnits_FocusModeGroups        -> SaveNexus_StepOne_FocusMode_Groups
    SaveNexus_FocusMode_Groups          -> SaveGSS_Range_FocusModeGroups    [label="Filename: 'PRL_<cycleNumber>.nxs'"]
    SaveGSS_Range_FocusModeGroups       -> ConvertUnits_PreSave_FocusModeGroups [label="Appending to Filename: 'PRL_<cycleNumber>.gss'"]
    ConvertUnits_PreSave_FocusModeGroups -> SaveNexus_Range_FocusModeGroups [label="Appending to Filename: 'PRL_<cycleNumber>.nxs'"]
    SaveNexus_FocusMode_Groups          -> Focus_run_if_debug_mode_FocusModeGroups
    //Finally debug mode test - Debug mode is off
    Focus_run_if_debug_mode_FocusModeGroups -> Remove_temp_workspace_FocusModeGroups   [label="false"]
    
    }
    
}